'use client'

import { useState, useEffect } from 'react'
import {
  LayoutDashboard,
  FolderOpen,
  Search,
  FileText,
  Calendar,
  Building2,
  Settings,
  Bell,
  HelpCircle,
  ChevronRight,
  ChevronDown,
  Menu,
  X,
  Plus,
  Briefcase,
  Euro,
  TrendingUp,
  Clock,
  Check
} from 'lucide-react'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent } from '@/components/ui/card'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { cn } from '@/lib/utils'
import { NewProjectDialog } from '@/components/new-project-dialog'
import { GrantSearch } from '@/components/grant-search'
import { ProjectsList } from '@/components/projects-list'
import { collectivitesAPI, projetsAPI, dispositifsAPI, dossiersAPI } from '@/lib/api'

const navigationItems = [
  { id: 'dashboard', label: 'Tableau de bord', icon: LayoutDashboard },
  { id: 'projects', label: 'Mes projets', icon: FolderOpen },
  { id: 'search', label: 'Recherche subventions', icon: Search },
  { id: 'files', label: 'Mes dossiers', icon: FileText },
  { id: 'calendar', label: 'Calendrier', icon: Calendar },
  { id: 'organizations', label: 'Collectivit√©s', icon: Building2 },
]

export default function GrantoLayout() {
  const [activeItem, setActiveItem] = useState('dashboard')
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)
  const [stats, setStats] = useState({
    projetsActifs: 0,
    projetsTotal: 0,
    montantTotal: 0,
    subventionsDemandees: 0,
    dossiersDeposes: 0
  })
  const [recentProjects, setRecentProjects] = useState([])
  const [loading, setLoading] = useState(true)

  // Charger les donn√©es depuis l'API
  useEffect(() => {
    loadDashboardData()
  }, [])

  const loadDashboardData = async () => {
    try {
      const [projets, dossiers] = await Promise.all([
        projetsAPI.getAll(),
        dossiersAPI.getAll()
      ])

      // Calculer les statistiques
      const projetsActifs = projets.filter((p: any) => p.statut === 'actif').length
      const montantTotal = projets.reduce((sum: number, p: any) => 
        sum + (parseFloat(p.montantTtc || 0)), 0
      )
      const subventionsDemandees = dossiers.reduce((sum: number, d: any) => 
        sum + (parseFloat(d.montantDemande || 0)), 0
      )

      setStats({
        projetsActifs,
        projetsTotal: projets.length,
        montantTotal,
        subventionsDemandees,
        dossiersDeposes: dossiers.length
      })

      // Prendre les 3 projets les plus r√©cents
      setRecentProjects(projets.slice(0, 3))
    } catch (error) {
      console.error('Erreur chargement dashboard:', error)
    } finally {
      setLoading(false)
    }
  }

  const formatEuro = (amount: number) => {
    if (amount >= 1000000) {
      return `${(amount / 1000000).toFixed(1)}M‚Ç¨`
    } else if (amount >= 1000) {
      return `${(amount / 1000).toFixed(0)}k‚Ç¨`
    }
    return `${amount}‚Ç¨`
  }

  const getStatutBadge = (statut: string) => {
    const badges: any = {
      'actif': { label: 'En cours', class: 'bg-blue-100 text-blue-800' },
      'brouillon': { label: 'Brouillon', class: 'bg-slate-100 text-slate-800' },
      'a_preparer': { label: 'Pr√™t √† d√©poser', class: 'bg-amber-100 text-amber-800' },
    }
    return badges[statut] || badges['brouillon']
  }

  const SidebarContent = () => (
    <>
      {/* Logo Section */}
      <div className="p-6">
        <div className="flex items-center gap-3">
          <Avatar className="h-10 w-10">
            <AvatarFallback className="bg-gradient-to-br from-blue-500 to-blue-600 text-white font-semibold">
              G
            </AvatarFallback>
          </Avatar>
          <span className="text-white font-semibold text-xl">Granto</span>
        </div>
      </div>

      {/* Navigation Menu */}
      <nav className="flex-1 px-3">
        <ul className="space-y-1">
          {navigationItems.map((item) => {
            const Icon = item.icon
            const isActive = activeItem === item.id
            return (
              <li key={item.id}>
                <button
                  onClick={() => {
                    setActiveItem(item.id)
                    setIsMobileMenuOpen(false)
                  }}
                  className={cn(
                    'w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-sm font-medium',
                    isActive
                      ? 'bg-blue-50 text-blue-600'
                      : 'text-slate-300 hover:bg-slate-700'
                  )}
                >
                  <Icon className="h-5 w-5" />
                  <span>{item.label}</span>
                </button>
              </li>
            )
          })}
        </ul>
      </nav>

      {/* Bottom Section */}
      <div className="border-t border-slate-700">
        <div className="px-3 py-3">
          <button
            onClick={() => setActiveItem('settings')}
            className={cn(
              'w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-sm font-medium',
              activeItem === 'settings'
                ? 'bg-blue-50 text-blue-600'
                : 'text-slate-300 hover:bg-slate-700'
            )}
          >
            <Settings className="h-5 w-5" />
            <span>Param√®tres</span>
          </button>
        </div>

        {/* User Profile Card */}
        <div className="px-3 pb-4">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <button className="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors">
                <Avatar className="h-9 w-9">
                  <AvatarFallback className="bg-blue-600 text-white text-sm">
                    GC
                  </AvatarFallback>
                </Avatar>
                <div className="flex-1 text-left">
                  <div className="text-white font-medium text-sm">Christophe G.</div>
                  <div className="text-slate-400 text-xs">c.gendron@stmars...</div>
                </div>
                <ChevronDown className="h-4 w-4 text-slate-400" />
              </button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-56">
              <DropdownMenuItem>Mon profil</DropdownMenuItem>
              <DropdownMenuItem>Param√®tres</DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem className="text-red-600">
                Se d√©connecter
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>
    </>
  )

  return (
    <div className="flex h-screen bg-slate-50">
      {/* Mobile Overlay */}
      {isMobileMenuOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 lg:hidden"
          onClick={() => setIsMobileMenuOpen(false)}
        />
      )}

      {/* Sidebar - Desktop */}
      <aside className="hidden lg:flex lg:flex-col w-60 bg-slate-800 border-r border-slate-700">
        <SidebarContent />
      </aside>

      {/* Sidebar - Mobile */}
      <aside
        className={cn(
          'fixed inset-y-0 left-0 z-50 w-60 bg-slate-800 border-r border-slate-700 transform transition-transform duration-300 ease-in-out lg:hidden flex flex-col',
          isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
        )}
      >
        {/* Mobile Close Button */}
        <div className="absolute top-4 right-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => setIsMobileMenuOpen(false)}
            className="text-slate-300 hover:text-white hover:bg-slate-700"
          >
            <X className="h-5 w-5" />
          </Button>
        </div>
        <SidebarContent />
      </aside>

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Header */}
        <header className="bg-white border-b border-slate-200 px-6 py-4">
          <div className="flex items-center justify-between">
            {/* Left: Mobile Menu + Breadcrumb */}
            <div className="flex items-center gap-4">
              <Button
                variant="ghost"
                size="icon"
                className="lg:hidden"
                onClick={() => setIsMobileMenuOpen(true)}
              >
                <Menu className="h-5 w-5" />
              </Button>

              <div className="flex items-center gap-2 text-sm text-slate-600">
                <span>Accueil</span>
                <ChevronRight className="h-4 w-4" />
                <span className="text-slate-900 font-medium">
                  {activeItem === 'search' ? 'Recherche subventions' : activeItem === 'projects' ? 'Mes projets' : 'Tableau de bord'}
                </span>
              </div>
            </div>

            {/* Right: Notifications, Help, User */}
            <div className="flex items-center gap-4">
              <Button variant="ghost" size="icon" className="relative">
                <Bell className="h-5 w-5" />
                <Badge
                  variant="destructive"
                  className="absolute -top-1 -right-1 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs"
                >
                  3
                </Badge>
              </Button>

              <Button variant="ghost" size="icon">
                <HelpCircle className="h-5 w-5" />
              </Button>

              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="icon" className="rounded-full">
                    <Avatar className="h-8 w-8">
                      <AvatarFallback className="bg-blue-600 text-white text-sm">
                        GC
                      </AvatarFallback>
                    </Avatar>
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end" className="w-56">
                  <DropdownMenuItem>Mon profil</DropdownMenuItem>
                  <DropdownMenuItem>Param√®tres</DropdownMenuItem>
                  <DropdownMenuSeparator />
                  <DropdownMenuItem className="text-red-600">
                    Se d√©connecter
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        </header>

        {/* Main Content */}
        <main className="flex-1 overflow-auto bg-slate-50">
          <div className="flex gap-6 p-8">
            {/* Main Content Column */}
            <div className="flex-1">
              {activeItem === 'search' ? (
                <GrantSearch />
              ) : activeItem === 'projects' ? (
                <ProjectsList />
              ) : (
                <div>
                  {/* Page Header */}
                  <div className="flex items-start justify-between mb-8">
                    <div>
                      <h1 className="text-3xl font-bold text-slate-900 mb-2">Tableau de bord</h1>
                      <p className="text-slate-600">Vue d'ensemble de vos projets et subventions</p>
                    </div>
                    <NewProjectDialog />
                  </div>

                  {loading ? (
                    <div className="flex justify-center items-center py-20">
                      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    </div>
                  ) : (
                    <>
                      {/* Metrics Section - DONN√âES R√âELLES */}
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        {/* Card 1 - Projets actifs */}
                        <Card className="border border-slate-200 shadow-sm">
                          <CardContent className="p-6">
                            <div className="flex items-start justify-between mb-4">
                              <div className="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100">
                                <Briefcase className="h-6 w-6 text-blue-600" />
                              </div>
                            </div>
                            <div className="space-y-1">
                              <div className="text-4xl font-bold text-slate-900">{stats.projetsActifs}</div>
                              <div className="text-sm text-slate-900">Projets actifs</div>
                              <div className="text-xs text-slate-500">{stats.projetsTotal} projets au total</div>
                            </div>
                          </CardContent>
                        </Card>

                        {/* Card 2 - Montant total */}
                        <Card className="border border-slate-200 shadow-sm">
                          <CardContent className="p-6">
                            <div className="flex items-start justify-between mb-4">
                              <div className="flex items-center justify-center w-12 h-12 rounded-full bg-green-100">
                                <Euro className="h-6 w-6 text-green-600" />
                              </div>
                            </div>
                            <div className="space-y-1">
                              <div className="text-4xl font-bold text-slate-900">{formatEuro(stats.montantTotal)}</div>
                              <div className="text-sm text-slate-900">Montant total</div>
                              <div className="text-xs text-slate-500">Co√ªt estim√© des projets</div>
                            </div>
                          </CardContent>
                        </Card>

                        {/* Card 3 - Subventions demand√©es */}
                        <Card className="border border-slate-200 shadow-sm">
                          <CardContent className="p-6">
                            <div className="flex items-start justify-between mb-4">
                              <div className="flex items-center justify-center w-12 h-12 rounded-full bg-purple-100">
                                <TrendingUp className="h-6 w-6 text-purple-600" />
                              </div>
                            </div>
                            <div className="space-y-1">
                              <div className="text-4xl font-bold text-slate-900">{formatEuro(stats.subventionsDemandees)}</div>
                              <div className="text-sm text-slate-900">Subventions demand√©es</div>
                              <div className="text-xs text-slate-500">{stats.dossiersDeposes} dossiers d√©pos√©s</div>
                            </div>
                          </CardContent>
                        </Card>

                        {/* Card 4 - Actions requises */}
                        <Card className="border border-slate-200 shadow-sm">
                          <CardContent className="p-6">
                            <div className="flex items-start justify-between mb-4">
                              <div className="flex items-center justify-center w-12 h-12 rounded-full bg-orange-100">
                                <Clock className="h-6 w-6 text-orange-600" />
                              </div>
                            </div>
                            <div className="space-y-1">
                              <div className="text-4xl font-bold text-slate-900">0</div>
                              <div className="text-sm text-slate-900">Actions requises</div>
                              <div className="text-xs text-slate-500">0 urgentes cette semaine</div>
                            </div>
                          </CardContent>
                        </Card>
                      </div>

                      {/* Recent Projects Section - DONN√âES R√âELLES */}
                      <div className="mb-8">
                        <div className="flex items-center justify-between mb-6">
                          <h2 className="text-xl font-semibold text-slate-900">Projets r√©cents</h2>
                          <button 
                            onClick={() => setActiveItem('projects')}
                            className="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1"
                          >
                            Voir tout
                            <ChevronRight className="h-4 w-4" />
                          </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                          {recentProjects.length === 0 ? (
                            <Card className="border border-slate-200 col-span-3">
                              <CardContent className="p-8 text-center text-slate-500">
                                Aucun projet pour le moment. Cr√©ez votre premier projet !
                              </CardContent>
                            </Card>
                          ) : (
                            recentProjects.map((projet: any) => {
                              const badge = getStatutBadge(projet.statut)
                              return (
                                <Card key={projet.id} className="border border-slate-200 hover:shadow-md transition-shadow cursor-pointer group">
                                  <CardContent className="p-6">
                                    <div className="flex items-start justify-between mb-4">
                                      <Badge className={`${badge.class} hover:${badge.class} rounded-full text-xs font-medium`}>
                                        {badge.label}
                                      </Badge>
                                    </div>
                                    <h3 className="text-lg font-semibold text-slate-900 mb-2">{projet.titre}</h3>
                                    {projet.collectivite && (
                                      <p className="text-sm text-slate-600 mb-4">{projet.collectivite.nom}</p>
                                    )}
                                    <div className="flex flex-wrap gap-2 mb-4">
                                      {projet.typeProjet && (
                                        <Badge variant="secondary" className="text-xs">{projet.typeProjet}</Badge>
                                      )}
                                      {projet.montantTtc && (
                                        <Badge variant="secondary" className="text-xs">
                                          {formatEuro(parseFloat(projet.montantTtc))}
                                        </Badge>
                                      )}
                                      {projet.dossiers && projet.dossiers.length > 0 && (
                                        <Badge variant="secondary" className="text-xs">
                                          üìä {projet.dossiers.length} subvention{projet.dossiers.length > 1 ? 's' : ''}
                                        </Badge>
                                      )}
                                    </div>
                                    <div className="flex justify-end">
                                      <ChevronRight className="h-5 w-5 text-slate-400 group-hover:text-blue-600 transition-colors" />
                                    </div>
                                  </CardContent>
                                </Card>
                              )
                            })
                          )}
                        </div>
                      </div>
                    </>
                  )}
                </div>
              )}
            </div>

            {/* Right Sidebar - Desktop Only (hide on search and projects pages) */}
            {activeItem !== 'search' && activeItem !== 'projects' && (
              <aside className="hidden xl:block w-80">
                <Card className="border border-slate-200">
                  <CardContent className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="font-semibold text-slate-900">√Ä faire</h3>
                      <Badge variant="secondary" className="rounded-full h-6 w-6 p-0 flex items-center justify-center">
                        0
                      </Badge>
                    </div>
                    <div className="flex flex-col items-center justify-center py-8">
                      <div className="flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
                        <Check className="h-8 w-8 text-green-600" />
                      </div>
                      <p className="text-sm text-slate-600 text-center">Tout est √† jour !</p>
                    </div>
                  </CardContent>
                </Card>
              </aside>
            )}
          </div>
        </main>
      </div>
    </div>
  )
}
